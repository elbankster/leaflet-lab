
<!DOCTYPE html>
<html lang="en">
<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Leaflet</title>
	
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css" crossorigin=""/>
</head>
<body>

<div id="left">
    <h2>Locations</h2>
    <ul>
        <li>Gibbons Park</li>
        <li>Komoka</li>
    </ul>

    <h2>Location Details</h2>
    
</div>
<div id="center">
    <div id="map"></div>
</div>
<div id="right">
    <h2>Trips</h2>
</div>

<script type="module">
    
    var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap'
    });

    // layer groups
    var public_launches = L.layerGroup();
    var user_locations = L.layerGroup();

    const map = L.map('map', {
    center: [42.98, -81.24],
    zoom: 12,
    layers: [osm, public_launches, user_locations]
    });

    var launchIcon = L.icon({
        iconUrl: 'media/boat_launch.png',
        iconSize: [30, 30], 
        iconAnchor: [15,0], 
    });

    var putInIcon = L.icon({
        iconUrl: 'media/oars.png',
        iconSize: [30, 30], 
        iconAnchor: [15, 5],
    });

    
    // query public launches and place the markers
    async function addPublicLaunches() {

        // get window bounds, used to build overpass query string
        const bounds = map.getBounds();

        // build query string
        const query = `
            [out:json];
            node["leisure"="slipway"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});out;
        `;
        
        var url = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);
        
        // get data from url
        fetch(url)
        .then(response => response.json())
        .then(data => {

            // Process the data returned
            data.elements.forEach(element => {
                if (element.type === 'node') {
                    
                    // add marker to the map
                    var marker = L.marker([element.lat, element.lon],{ icon: launchIcon });

                    // if this node has a name identified, add it as a popup
                    if(element.tags.name) {
                        marker.bindPopup(element.tags.name);
                    }

                    public_launches.addLayer(marker);
                }
            });
        
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
    
    }

    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://kuuapkkqpvpqekfoicfq.supabase.co';
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1dWFwa2txcHZwcWVrZm9pY2ZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUyMzM1MjQsImV4cCI6MjA1MDgwOTUyNH0.pR3vYyDNMVRLlxcY3pWqZleXr65VUSmcB_owfPhfOBo"
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function addUserLocation(e) {

        const name = prompt("Name this location:");
        if (!name) return;

        const waterway = prompt("Waterway:");
        if (!waterway) return;

        const gauge_id = prompt("Gauge ID:");
        const rec_flow = prompt("Recommended flow:");
        const min_flow = prompt("Minimum flow:");
        const max_flow = prompt("Maximim flow");
        const latitude = e.latlng.lat;
        const longitude = e.latlng.lng;

        try {
            const { data, error } = await supabase
                .from('user_location')
                .insert([{ 
                    name: name,
                    waterway: waterway,
                    lat: latitude, 
                    lon: longitude,
                    gauge_id: gauge_id,
                    flow_low: min_flow,
                    flow_high: max_flow,
                    flow_rec: rec_flow
                 }]);

            if (error) {
                console.error("Error saving location:", error);
                alert("Failed to save the location. Please try again.");
            } else {
                console.log("Location saved:", data);
                L.marker(e.latlng, { icon: putInIcon })
                    .addTo(user_locations)
                    .bindPopup(`${name}\n${waterway}`)
                    .openPopup();
            }
        } catch (err) {
            console.error("Unexpected error:", err);
        }        
        
    }

    async function loadUserLocations() {
        try {
            const { data, error } = await supabase
                .from('user_location')
                .select('*');

            if (error) {
                console.error("Error loading user locations:", error);
                return;
            }

            data.forEach(location => {
                const marker = L.marker([location.lat, location.lon], { icon: putInIcon })
                    .addTo(user_locations)
                    .bindPopup(`
                        <strong>${location.name}</strong><br>
                        ${location.waterway}<br>
                        Flow: ${location.flow_rec || 'N/A'} (Recommended)<br>
                        Min: ${location.flow_low || 'N/A'}, Max: ${location.flow_high || 'N/A'}
                    `);

                user_locations.addLayer(marker);
            });

            console.log("User locations loaded:", data);
        } catch (err) {
            console.error("Unexpected error while loading user locations:", err);
        }
    }    

    addPublicLaunches();
    loadUserLocations();

    map.on('moveend',addPublicLaunches);
    map.on('click', addUserLocation);

    // Add the layer group to the map's layer control
    var baseLayers = {
        "OpenStreetMap": osm
    };

    var overlayLayers = {
        "Public Launches": public_launches,
        "User Locations": user_locations
    };

    L.control.layers(baseLayers, overlayLayers).addTo(map);

</script>



</body>
</html>
